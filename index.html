<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>関数グラフ・シミュレーター</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Roboto+Mono:wght@500&display=swap" rel="stylesheet">
    
    <!-- React & ReactDOM (UMD) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Recharts (UMD) -->
    <!-- Note: Prop-types is a dependency for Recharts UMD in some versions, ensuring it loads first just in case, though production react usually handles it. -->
    <script src="https://unpkg.com/recharts@2.12.0/umd/Recharts.min.js"></script>

    <!-- Babel (for JSX compilation in browser) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ['"Noto Sans JP"', 'sans-serif'],
              mono: ['"Roboto Mono"', 'monospace'],
            },
          },
        },
      }
    </script>
<script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@^19.2.3",
    "react-dom/": "https://esm.sh/react-dom@^19.2.3/",
    "react/": "https://esm.sh/react@^19.2.3/",
    "recharts": "https://esm.sh/recharts@^3.6.0"
  }
}
</script>
</head>
<body class="bg-slate-50 text-slate-900 antialiased">
    <div id="root"></div>

    <script type="text/babel">
        // グローバル変数からReactとRechartsを取得
        const { useState, useMemo } = React;
        const { 
            LineChart, Line, XAxis, YAxis, CartesianGrid, 
            ResponsiveContainer, ReferenceLine 
        } = Recharts;

        // --- Types ---
        const FunctionType = {
            PROPORTIONAL: 'PROPORTIONAL',
            INVERSE_PROPORTIONAL: 'INVERSE_PROPORTIONAL',
            LINEAR: 'LINEAR',
            QUADRATIC: 'QUADRATIC',
        };

        const FUNCTIONS = [
            { id: FunctionType.PROPORTIONAL, label: '比例', formula: 'y = ax', description: '原点を通る直線' },
            { id: FunctionType.INVERSE_PROPORTIONAL, label: '反比例', formula: 'y = a/x', description: '双曲線' },
            { id: FunctionType.LINEAR, label: '一次関数', formula: 'y = ax + b', description: '直線' },
            { id: FunctionType.QUADRATIC, label: '二次関数', formula: 'y = ax²', description: '放物線' },
        ];

        // --- Utils ---
        const gcd = (a, b) => {
            return b === 0 ? a : gcd(b, a % b);
        };

        const toFraction = (value) => {
            if (value === 0) {
                return { numerator: 0, denominator: 1, sign: 0, isInteger: true };
            }
            const sign = value < 0 ? -1 : 1;
            const absValue = Math.abs(value);

            if (Math.abs(Math.round(absValue) - absValue) < 0.0001) {
                return {
                    numerator: Math.round(absValue),
                    denominator: 1,
                    sign,
                    isInteger: true,
                };
            }

            let denominator = 1;
            let numerator = absValue;
            while (Math.abs(Math.round(numerator) - numerator) > 0.0001 && denominator < 1000) {
                numerator *= 10;
                denominator *= 10;
            }
            numerator = Math.round(numerator);
            const commonDivisor = gcd(numerator, denominator);
            return {
                numerator: numerator / commonDivisor,
                denominator: denominator / commonDivisor,
                sign,
                isInteger: false,
            };
        };

        const generatePoints = (a, b, funcType, rangeX = [-10, 10], step = 0.2) => {
            const points = [];
            const xValues = new Set();

            // Generate regular ticks
            for (let x = rangeX[0]; x <= rangeX[1]; x = parseFloat((x + step).toFixed(2))) {
                xValues.add(x);
            }

            // Add precision points for Inverse Proportion to hit edges
            if (funcType === FunctionType.INVERSE_PROPORTIONAL) {
                 // Close to zero points
                 [0.01, 0.02, 0.05, 0.1, 0.15, -0.01, -0.02, -0.05, -0.1, -0.15].forEach(x => xValues.add(x));
                 // Points to ensure we hit y=10 or y=-10 if a is small
                 if (a !== 0) {
                    const targetY = 10;
                    xValues.add(a / targetY);
                    xValues.add(a / -targetY);
                 }
                 xValues.add(0); // Break point
            }

            const sortedX = Array.from(xValues).sort((a, b) => a - b);

            for (const x of sortedX) {
                // Bounds check
                if (x < rangeX[0] || x > rangeX[1]) continue;

                let y = null;
                if (funcType === FunctionType.INVERSE_PROPORTIONAL && Math.abs(x) < 0.0001) {
                    y = null;
                } else {
                    switch (funcType) {
                        case FunctionType.PROPORTIONAL: y = a * x; break;
                        case FunctionType.INVERSE_PROPORTIONAL: y = x === 0 ? null : a / x; break;
                        case FunctionType.LINEAR: y = a * x + b; break;
                        case FunctionType.QUADRATIC: y = a * x * x; break;
                    }
                }
                points.push({ x, y });
            }
            return points;
        };

        // --- Components ---
        
        const FractionDisplay = ({ value, omitOne = false }) => {
            const f = toFraction(value);
            if (f.sign === 0) return <span>0</span>;
            if (f.isInteger) {
                if (omitOne && f.numerator === 1) {
                    return f.sign === -1 ? <span>-</span> : null;
                }
                return <span>{f.sign === -1 ? '-' : ''}{f.numerator}</span>;
            }
            return (
                <div className="inline-flex items-center mx-1">
                    {f.sign === -1 && <span className="mr-1 font-bold">-</span>}
                    <div className="flex flex-col items-center text-center leading-none">
                        <span className="border-b-2 border-slate-800 w-full px-1 mb-[1px]">{f.numerator}</span>
                        <span>{f.denominator}</span>
                    </div>
                </div>
            );
        };

        const EquationDisplay = ({ type, a, b }) => {
            return (
                <div className="flex items-center justify-center p-6 bg-white rounded-xl shadow-sm border border-slate-200 min-h-[120px]">
                    <div className="text-4xl font-serif italic text-slate-800 flex items-center gap-1">
                        <span className="mr-3">y =</span>

                        {type === FunctionType.PROPORTIONAL && (
                            a === 0 ? <span>0</span> : (
                                <>
                                    <FractionDisplay value={a} omitOne />
                                    <span className="ml-1">x</span>
                                </>
                            )
                        )}

                        {type === FunctionType.INVERSE_PROPORTIONAL && (
                             a === 0 ? <span>0</span> : (() => {
                                 const f = toFraction(a);
                                 const isNeg = f.sign === -1;
                                 return (
                                     <div className="inline-flex items-center">
                                         {isNeg && <span className="mr-2 font-bold">-</span>}
                                         <div className="flex flex-col items-center text-center leading-none">
                                             <span className="border-b-2 border-slate-800 w-full px-2 mb-1">{f.numerator}</span>
                                             <span>
                                                 {f.denominator !== 1 ? f.denominator : ''}x
                                             </span>
                                         </div>
                                     </div>
                                 );
                             })()
                        )}

                        {type === FunctionType.LINEAR && (
                             a === 0 ? <span>{b}</span> : (
                                <>
                                    <FractionDisplay value={a} omitOne />
                                    <span className="ml-1">x</span>
                                    {b !== 0 && (
                                        <>
                                            <span className="mx-3 text-slate-400">{b > 0 ? '+' : '-'}</span>
                                            <span>{Math.abs(b)}</span>
                                        </>
                                    )}
                                </>
                             )
                        )}

                        {type === FunctionType.QUADRATIC && (
                             a === 0 ? <span>0</span> : (
                                <>
                                    <FractionDisplay value={a} omitOne />
                                    <span className="ml-1">x²</span>
                                </>
                             )
                        )}
                    </div>
                </div>
            );
        };

        const ControlPanel = ({ type, a, setA, b, setB }) => {
            const step = 0.5;
            return (
                <div className="bg-slate-50 p-6 rounded-xl border border-slate-200 space-y-8">
                    <h3 className="text-sm font-bold text-slate-500 uppercase tracking-wider mb-4">パラメータ操作</h3>
                    <div className="space-y-3">
                        <div className="flex justify-between items-center mb-1">
                            <label htmlFor="slider-a" className="font-serif italic text-2xl text-slate-700">a = {a}</label>
                            <span className="text-xs text-slate-400">係数</span>
                        </div>
                        <input
                            id="slider-a"
                            type="range"
                            min="-5"
                            max="5"
                            step={step}
                            value={a}
                            onChange={(e) => setA(parseFloat(e.target.value))}
                            className="w-full h-3 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-blue-600"
                        />
                         <div className="flex justify-between text-xs text-slate-400 font-mono">
                            <span>-5</span>
                            <span>0</span>
                            <span>5</span>
                        </div>
                    </div>

                    {type === FunctionType.LINEAR && (
                        <div className="space-y-3 pt-4 border-t border-slate-200">
                           <div className="flex justify-between items-center mb-1">
                                <label htmlFor="slider-b" className="font-serif italic text-2xl text-slate-700">b = {b}</label>
                                <span className="text-xs text-slate-400">切片</span>
                           </div>
                           <input
                                id="slider-b"
                                type="range"
                                min="-10"
                                max="10"
                                step="1"
                                value={b}
                                onChange={(e) => setB(parseFloat(e.target.value))}
                                className="w-full h-3 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-green-600"
                           />
                           <div className="flex justify-between text-xs text-slate-400 font-mono">
                                <span>-10</span>
                                <span>0</span>
                                <span>10</span>
                           </div>
                        </div>
                    )}
                </div>
            );
        };

        const GraphCanvas = ({ type, a, b }) => {
            const data = useMemo(() => generatePoints(a, b, type, [-11, 11], 0.2), [a, b, type]);
            // Ticks every 1 unit from -10 to 10
            const ticks = useMemo(() => Array.from({ length: 21 }, (_, i) => i - 10), []);

            return (
                <div className="w-full aspect-square bg-white rounded-xl shadow-sm border border-slate-200 p-2 relative overflow-hidden">
                    <ResponsiveContainer width="100%" height="100%">
                        <LineChart data={data} margin={{ top: 20, right: 20, left: 20, bottom: 20 }}>
                            <CartesianGrid strokeDasharray="3 3" stroke="#e2e8f0" />
                            <XAxis 
                                dataKey="x" 
                                type="number" 
                                domain={[-10, 10]} 
                                ticks={ticks} 
                                stroke="#64748b" 
                                allowDataOverflow={true} 
                                interval={0}
                                tick={{fontSize: 9}}
                            />
                            <YAxis 
                                type="number" 
                                domain={[-10, 10]} 
                                ticks={ticks} 
                                stroke="#64748b" 
                                allowDataOverflow={true} 
                                interval={0}
                                tick={{fontSize: 9}}
                            />
                            <ReferenceLine x={0} stroke="#334155" strokeWidth={2} />
                            <ReferenceLine y={0} stroke="#334155" strokeWidth={2} />
                            <Line
                                type="monotone"
                                dataKey="y"
                                stroke="#2563eb"
                                strokeWidth={3}
                                dot={false}
                                isAnimationActive={false}
                                connectNulls={false}
                            />
                        </LineChart>
                    </ResponsiveContainer>
                    <div className="absolute top-2 left-1/2 -translate-x-1/2 text-sm font-serif italic text-slate-600">y</div>
                    <div className="absolute right-2 top-1/2 -translate-y-1/2 text-sm font-serif italic text-slate-600">x</div>
                </div>
            );
        };

        const App = () => {
            const [selectedType, setSelectedType] = useState(FunctionType.PROPORTIONAL);
            const [a, setA] = useState(1);
            const [b, setB] = useState(0);

            const handleTypeChange = (type) => {
                setSelectedType(type);
                setA(type === FunctionType.INVERSE_PROPORTIONAL ? 4 : 1);
                setB(0);
            };

            const currentConfig = FUNCTIONS.find(f => f.id === selectedType);

            return (
                <div className="min-h-screen bg-slate-50 py-8 px-4 sm:px-6 lg:px-8 font-sans">
                    <div className="max-w-5xl mx-auto space-y-8">
                        <header className="text-center space-y-2">
                            <h1 className="text-3xl font-bold text-slate-900 tracking-tight">関数グラフ・シミュレーター</h1>
                            <p className="text-slate-500">スライダーを動かして、グラフの形と式の変化を見てみよう</p>
                        </header>

                        <nav className="flex flex-wrap justify-center gap-2 p-1 bg-slate-200 rounded-xl max-w-2xl mx-auto">
                            {FUNCTIONS.map((func) => (
                                <button
                                    key={func.id}
                                    onClick={() => handleTypeChange(func.id)}
                                    className={`
                                        px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200 flex-1 sm:flex-none
                                        ${selectedType === func.id 
                                        ? 'bg-white text-blue-600 shadow-sm' 
                                        : 'text-slate-600 hover:bg-slate-300/50 hover:text-slate-800'}
                                    `}
                                >
                                    <span className="block">{func.label}</span>
                                    <span className="text-xs opacity-70 font-serif hidden sm:block">{func.formula}</span>
                                </button>
                            ))}
                        </nav>

                        <main className="grid grid-cols-1 lg:grid-cols-12 gap-6 items-start">
                            <div className="lg:col-span-5 space-y-6">
                                <div className="bg-blue-50 border border-blue-100 p-4 rounded-lg text-blue-800 text-sm">
                                    <span className="font-bold">Point:</span> {currentConfig.description}
                                </div>
                                <EquationDisplay type={selectedType} a={a} b={b} />
                                <ControlPanel type={selectedType} a={a} setA={setA} b={b} setB={setB} />
                            </div>
                            <div className="lg:col-span-7">
                                <GraphCanvas type={selectedType} a={a} b={b} />
                                <p className="mt-2 text-center text-xs text-slate-400">
                                    ※ グラフの線は常に青色で表示されます
                                </p>
                            </div>
                        </main>

                        <footer className="text-center text-slate-400 text-xs pt-8 border-t border-slate-200">
                            <p>Created for Middle School Mathematics Education</p>
                        </footer>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>